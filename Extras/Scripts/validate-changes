#!/bin/bash
# Purpose: Verify local changes via formatting/linting, unsigned app builds across platforms, and tests.
# Usage: Extras/Scripts/validate-changes [--clean] [--tests] [--ui-tests]

set -euo pipefail

cd "$(dirname "${BASH_SOURCE[0]}")"
cd "$(readlink -f .)/../.."
ROOT="$(pwd)"

FORCE_CLEAN=0
RUN_TESTS=1
INCLUDE_UI_TESTS=0
while [ "$#" -gt 0 ]; do
  case "$1" in
    --clean|-c)
      FORCE_CLEAN=1
      ;;
    --tests|-t)
      RUN_TESTS=1
      ;;
    --ui-tests|-u)
      RUN_TESTS=1
      INCLUDE_UI_TESTS=1
      ;;
    -h|--help)
      echo "Usage: Extras/Scripts/validate-changes [--clean] [--tests] [--ui-tests]"
      echo "  --clean, -c   remove local build artifacts and run clean builds"
      echo "  --tests, -t   run tests (default runs non-UI tests)"
      echo "  --ui-tests, -u   include UI tests (implies --tests)"
      exit 0
      ;;
    *)
      echo "Unknown argument: $1"
      echo "Usage: Extras/Scripts/validate-changes [--clean] [--tests] [--ui-tests]"
      exit 1
      ;;
  esac
  shift
done

CACHE_ROOT="$ROOT/.build/cache"
VERIFY_ROOT="$ROOT/.build/verify"
DERIVED_DATA_PATH="$ROOT/.build/derived-data"

if [ "$FORCE_CLEAN" -eq 1 ]; then
  echo "==> Clean mode enabled: removing local build artifacts and caches"
  rm -rf "$ROOT/.build"
fi

mkdir -p "$CACHE_ROOT/clang-module-cache" "$CACHE_ROOT/swift-module-cache" "$CACHE_ROOT/xdg-cache" "$CACHE_ROOT/home" "$VERIFY_ROOT"
export HOME="$CACHE_ROOT/home"
export CLANG_MODULE_CACHE_PATH="$CACHE_ROOT/clang-module-cache"
export SWIFTPM_MODULECACHE_OVERRIDE="$CACHE_ROOT/swift-module-cache"
export XDG_CACHE_HOME="$CACHE_ROOT/xdg-cache"

echo "==> Validating changes in $ROOT"

CHANGED_SWIFT_FILES=()
while IFS= read -r line; do
  CHANGED_SWIFT_FILES+=("$line")
done < <(
  {
    git diff --name-only -- "*.swift"
    git diff --cached --name-only -- "*.swift"
    git ls-files --others --exclude-standard -- "*.swift"
  } | awk '!seen[$0]++'
)

if [ "${#CHANGED_SWIFT_FILES[@]}" -gt 0 ]; then
  if command -v swift >/dev/null 2>&1; then
    echo "==> Formatting changed Swift files"
    swift format --in-place "${CHANGED_SWIFT_FILES[@]}"

    echo "==> Linting changed Swift files"
    swift format lint "${CHANGED_SWIFT_FILES[@]}"
  else
    echo "Swift toolchain not found; skipping format/lint"
  fi
else
  echo "No changed Swift files to format or lint."
fi

echo "==> Building app schemes with xcodebuild (no code signing)"
if [ "$FORCE_CLEAN" -eq 1 ]; then
  rm -rf "$DERIVED_DATA_PATH"
fi

IOS_LOG="$VERIFY_ROOT/validate_changes_ios.log"
MACOS_LOG="$VERIFY_ROOT/validate_changes_macos.log"
TVOS_LOG="$VERIFY_ROOT/validate_changes_tvos.log"
TEST_LOG="$VERIFY_ROOT/validate_changes_tests.log"

XCODE_ACTION=(build)
if [ "$FORCE_CLEAN" -eq 1 ]; then
  XCODE_ACTION=(clean build)
fi

xcodebuild \
  -workspace "$ROOT/ActionStatus.xcworkspace" \
  -scheme ActionStatus \
  -destination "generic/platform=iOS" \
  -derivedDataPath "$DERIVED_DATA_PATH" \
  CODE_SIGNING_ALLOWED=NO \
  "${XCODE_ACTION[@]}" >"$IOS_LOG" 2>&1

xcodebuild \
  -workspace "$ROOT/ActionStatus.xcworkspace" \
  -scheme ActionStatus \
  -destination "generic/platform=macOS" \
  -derivedDataPath "$DERIVED_DATA_PATH" \
  CODE_SIGNING_ALLOWED=NO \
  "${XCODE_ACTION[@]}" >"$MACOS_LOG" 2>&1

xcodebuild \
  -workspace "$ROOT/ActionStatus.xcworkspace" \
  -scheme ActionStatus-tvOS \
  -destination "generic/platform=tvOS" \
  -derivedDataPath "$DERIVED_DATA_PATH" \
  CODE_SIGNING_ALLOWED=NO \
  "${XCODE_ACTION[@]}" >"$TVOS_LOG" 2>&1

if [ "$RUN_TESTS" -eq 1 ]; then
  echo "==> Running tests"
  IOS_TEST_DESTINATION=""

  # Prefer an already-booted iPhone simulator to avoid extra launch cost.
  IOS_TEST_DESTINATION="$(
    xcrun simctl list devices available 2>/dev/null \
      | awk '
          /^-- iOS / {
            os = $0
            gsub(/^-- iOS /, "", os)
            gsub(/ --$/, "", os)
          }
          /\(Booted\)/ && /iPhone/ && $0 !~ /\(unavailable/ {
            line = $0
            sub(/^[[:space:]]+/, "", line)
            sub(/[[:space:]]+\(.*/, "", line)
            if (os != "") {
              printf "platform=iOS Simulator,OS=%s,name=%s\n", os, line
              exit
            }
          }
        '
  )"

  # If no iPhone is booted, use any already-booted iOS simulator.
  if [ -z "$IOS_TEST_DESTINATION" ]; then
    IOS_TEST_DESTINATION="$(
      xcrun simctl list devices available 2>/dev/null \
        | awk '
            /^-- iOS / {
              os = $0
              gsub(/^-- iOS /, "", os)
              gsub(/ --$/, "", os)
            }
            /\(Booted\)/ && $0 !~ /\(unavailable/ {
              line = $0
              sub(/^[[:space:]]+/, "", line)
              sub(/[[:space:]]+\(.*/, "", line)
              if (os != "") {
                printf "platform=iOS Simulator,OS=%s,name=%s\n", os, line
                exit
              }
            }
          '
    )"
  fi

  # Otherwise prefer an iPhone simulator from Xcode destinations.
  if [ -z "$IOS_TEST_DESTINATION" ]; then
    IOS_TEST_DESTINATION="$(
      xcodebuild -workspace "$ROOT/ActionStatus.xcworkspace" -scheme ActionStatus -showdestinations 2>/dev/null \
        | awk -F'[,}]' '
            /platform:iOS Simulator/ && $0 !~ /placeholder/ {
              os = ""
              name = ""
              for (i = 1; i <= NF; i++) {
                gsub(/^[[:space:]]+|[[:space:]]+$/, "", $i)
                if ($i ~ /^OS:/) {
                  sub(/^OS:/, "", $i)
                  os = $i
                }
                if ($i ~ /^name:/) {
                  sub(/^name:/, "", $i)
                  name = $i
                }
              }
              if (os != "" && name != "" && name ~ /^iPhone/) {
                printf "platform=iOS Simulator,OS=%s,name=%s\n", os, name
                exit
              }
            }
          '
    )"
  fi

  # Final fallback: first available iOS simulator.
  if [ -z "$IOS_TEST_DESTINATION" ]; then
    IOS_TEST_DESTINATION="$(
      xcodebuild -workspace "$ROOT/ActionStatus.xcworkspace" -scheme ActionStatus -showdestinations 2>/dev/null \
        | awk -F'[,}]' '
            /platform:iOS Simulator/ && $0 !~ /placeholder/ {
              os = ""
              name = ""
              for (i = 1; i <= NF; i++) {
                gsub(/^[[:space:]]+|[[:space:]]+$/, "", $i)
                if ($i ~ /^OS:/) {
                  sub(/^OS:/, "", $i)
                  os = $i
                }
                if ($i ~ /^name:/) {
                  sub(/^name:/, "", $i)
                  name = $i
                }
              }
              if (os != "" && name != "") {
                printf "platform=iOS Simulator,OS=%s,name=%s\n", os, name
                exit
              }
            }
          '
    )"
  fi

  if [ -z "$IOS_TEST_DESTINATION" ]; then
    echo "No available iOS simulator found for test execution."
    exit 1
  fi

  echo "Using iOS test destination: $IOS_TEST_DESTINATION"

  TEST_ARGS=()
  if [ "$INCLUDE_UI_TESTS" -eq 1 ]; then
    echo "Including UI tests."
  else
    echo "Skipping UI tests (use --ui-tests to include)."
    TEST_ARGS+=("-only-testing:ActionStatusTests")
    TEST_ARGS+=("-only-testing:CoreTests")
  fi

  xcodebuild \
    -workspace "$ROOT/ActionStatus.xcworkspace" \
    -scheme ActionStatus \
    -testPlan ActionStatus \
    -destination "$IOS_TEST_DESTINATION" \
    -derivedDataPath "$DERIVED_DATA_PATH" \
    CODE_SIGNING_ALLOWED=NO \
    "${TEST_ARGS[@]}" \
    test >"$TEST_LOG" 2>&1
fi

echo "==> Verification complete"
echo "iOS build log: $IOS_LOG"
echo "macOS build log: $MACOS_LOG"
echo "tvOS build log: $TVOS_LOG"
echo "test log: $TEST_LOG"
